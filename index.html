<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–ß–µ—Ä–≥–∏ –≤–∞–Ω—Ç–∞–∂—ñ–≤–æ–∫ –Ω–∞ –∫–æ—Ä–¥–æ–Ω—ñ –£–∫—Ä–∞—ó–Ω–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    .legend {
      background: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      font-size: 13px;
      line-height: 1.4;
    }

    .legend-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 2px;
    }

    .legend-color {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
    }

    .legend-color.green { background: #2ecc71; }
    .legend-color.yellow { background: #f1c40f; }
    .legend-color.red { background: #e74c3c; }
    .legend-color.gray { background: #7f8c8d; }

    .popup-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .popup-meta {
      font-size: 12px;
      color: #555;
      margin-bottom: 4px;
    }

    .popup-kpi {
      font-size: 13px;
      margin-bottom: 2px;
    }

    .top-panel {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: rgba(255,255,255,0.95);
      padding: 6px 12px;
      border-radius: 999px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      font-size: 12px;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="info" class="top-panel">
    –î–∞–Ω—ñ –ø—Ä–æ —á–µ—Ä–≥–∏ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- –°—Ç–∞—Ç–∏—á–Ω—ñ –ö–ü–ü -->
  <script src="border-data.js"></script>
  <!-- –î–∏–Ω–∞–º—ñ—á–Ω—ñ —á–µ—Ä–≥–∏ —è–∫ JS-–æ–± º—î–∫—Ç -->
  <script src="queues.js"></script>

  <script>
    const infoDiv = document.getElementById("info");

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Ä—Ç–∏
    const map = L.map("map").setView([49.0, 24.0], 6);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 10,
      minZoom: 5,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    function getColor(status, waitMinutes) {
      if (status === "green") return "#2ecc71";
      if (status === "yellow") return "#f1c40f";
      if (status === "red") return "#e74c3c";

      if (typeof waitMinutes === "number") {
        if (waitMinutes < 120) return "#2ecc71";
        if (waitMinutes <= 360) return "#f1c40f";
        return "#e74c3c";
      }
      return "#7f8c8d"; // gray
    }

    function createMarker(point) {
      if (!point.lat || !point.lon) return null;

      const color = getColor(point.status, point.wait_minutes);
      const marker = L.circleMarker([point.lat, point.lon], {
        radius: 9,
        fillColor: color,
        color: "#ffffff",
        weight: 1,
        opacity: 1,
        fillOpacity: 0.9
      });

      const trucks = point.trucks_in_queue;
      const waitMin = point.wait_minutes;
      const hasData = typeof trucks === "number" && typeof waitMin === "number";

      let waitHours = null;
      let waitDays = null;

      if (hasData) {
        waitHours = (waitMin / 60).toFixed(1);      // –≥–æ–¥–∏–Ω–∏
        waitDays = (waitHours / 24).toFixed(1);     // –¥–æ–±–∏
      }

      const updatedAt = point.dataUpdatedAt
        ? new Date(point.dataUpdatedAt).toLocaleString("uk-UA")
        : "–Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö";

      const popupHtml = `
        <div class="popup">
          <div class="popup-title">${point.name}</div>
          <div class="popup-meta">
            –ù–∞–ø—Ä—è–º–æ–∫: ${point.direction || "-"}<br/>
            –ö—Ä–∞—ó–Ω–∏: ${point.countryFrom || "UA"} ‚Üí ${point.countryTo || "?"}
          </div>
          <div class="popup-kpi">
            üöö –£ —á–µ—Ä–∑—ñ: <strong>${hasData ? trucks : "–Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö"}</strong>
          </div>
          <div class="popup-kpi">
            ‚è± –û—á—ñ–∫—É–≤–∞–Ω–Ω—è: <strong>
              ${
                hasData
                  ? `${waitHours} –≥–æ–¥. ("${waitDays} –¥—ñ–±")`
                  : "–Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö"
              }
            </strong>
          </div>
          <div class="popup-meta">
            –û–Ω–æ–≤–ª–µ–Ω–æ: ${updatedAt}
          </div>
        </div>
      `;

      marker.bindPopup(popupHtml);
      return marker;
    }

    function mergePoints() {
      if (typeof BORDER_POINTS === "undefined") {
        console.error("BORDER_POINTS –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ");
        infoDiv.textContent = "–ü–æ–º–∏–ª–∫–∞: –Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø—Ä–æ –ö–ü–ü.";
        return [];
      }

      if (typeof QUEUES_DATA === "undefined") {
        console.warn("QUEUES_DATA –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –ø–æ–∫–∞–∑—É—î–º–æ –ª–∏—à–µ –ö–ü–ü –±–µ–∑ —á–µ—Ä–≥");
        infoDiv.textContent = "–ß–µ—Ä–≥–∏ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ.";
        return BORDER_POINTS.map(p => ({
          ...p,
          trucks_in_queue: null,
          wait_minutes: null,
          status: "gray",
          dataUpdatedAt: null
        }));
      }

      const updatedAtGlobal = QUEUES_DATA.updated_at || null;
      const byId = new Map(
        (QUEUES_DATA.points || []).map(p => [p.id, p])
      );

      let totalTrucks = 0;
      let countWithData = 0;
      let sumWait = 0;

      const merged = BORDER_POINTS.map(p => {
        const q = byId.get(p.id);
        if (q && typeof q.trucks_in_queue === "number" && typeof q.wait_minutes === "number") {
          totalTrucks += q.trucks_in_queue;
          sumWait += q.wait_minutes;
          countWithData += 1;

          return {
            ...p,
            trucks_in_queue: q.trucks_in_queue,
            wait_minutes: q.wait_minutes,
            status: q.status,
            dataUpdatedAt: q.updated_at || updatedAtGlobal
          };
        }
        return {
          ...p,
          trucks_in_queue: null,
          wait_minutes: null,
          status: "gray",
          dataUpdatedAt: updatedAtGlobal
        };
      });

      const avgWaitHours = countWithData > 0 ? (sumWait / countWithData / 60).toFixed(1) : "‚Äî";

      infoDiv.textContent =
        `–í–∞–Ω—Ç–∞–∂–Ω—ñ –ö–ü–ü: ${merged.length} | ` +
        `–£ —á–µ—Ä–∑—ñ ~ ${totalTrucks} —Ñ—É—Ä | ` +
        `–°–µ—Ä–µ–¥–Ω—î –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è: ${avgWaitHours} –≥–æ–¥. | ` +
        `–î–∞–Ω—ñ –æ–Ω–æ–≤–ª–µ–Ω–æ: ${
          updatedAtGlobal
            ? new Date(updatedAtGlobal).toLocaleString("uk-UA")
            : "–Ω–µ–º–∞—î —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó"
        }`;

      return merged;
    }

    function render(points) {
      points.forEach(p => {
        const m = createMarker(p);
        if (m) m.addTo(map);
      });
    }

    const mergedPoints = mergePoints();
    render(mergedPoints);

    // –õ–µ–≥–µ–Ω–¥–∞
    const legend = L.control({ position: "bottomleft" });
    legend.onAdd = function () {
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = `
        <div class="legend-title">–°—Ç–∞—Ç—É—Å —á–µ—Ä–≥–∏ (–≤–∞–Ω—Ç–∞–∂—ñ–≤–∫–∏)</div>
        <div class="legend-item">
          <span class="legend-color green"></span> –ù–∏–∑—å–∫–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è (&lt; 2 –≥–æ–¥)
        </div>
        <div class="legend-item">
          <span class="legend-color yellow"></span> –°–µ—Ä–µ–¥–Ω—î (2‚Äì6 –≥–æ–¥)
        </div>
        <div class="legend-item">
          <span class="legend-color red"></span> –í–∏—Å–æ–∫–µ (&gt; 6 –≥–æ–¥)
        </div>
        <div class="legend-item">
          <span class="legend-color gray"></span> –ù–µ–º–∞—î –¥–∞–Ω–∏—Ö
        </div>
      `;
      return div;
    };
    legend.addTo(map);
  </script>
</body>
</html>

